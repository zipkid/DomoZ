#!/bin/env ruby
# encoding: utf-8

require 'daemons'
require 'optparse'
require 'ostruct'
require 'pp'

require 'domoz'

class Parser
  def self.parse(args)
    options = OpenStruct.new
    options.debug = false
    options.foreground = false

    opt_parser = OptionParser.new do |opts|
      opts.banner = 'Usage: #{$PROGRAM_NAME} [options]'

      opts.on('-d', '--debug [LEVEL]', 'Debug level') do |n|
        options.debug = n
      end

      # Boolean switch.
      opts.on('-f', '--[no-]foreground', 'Run in foreground') do |v|
        options.foreground = v
      end

      opts.on('-h', '--help', 'Prints this help') do
        puts opts
        exit
      end
    end

    opt_parser.parse!(args)
    options
  end
end
options = Parser.parse(ARGV) # %w[--help]

# pp options

deamons_options = {
  ontop: options.foreground,
  backtrace: true,
  app_name: 'domoz',
  log_output: true,
  dir_mode: :normal,
  dir: '.'
}

Daemons.daemonize(deamons_options)

domoz = Domoz.new

trap 'SIGINT' do
  puts 'Waiting for termination'
  # Thread.new { |t| domoz.stop }
  domoz.stop
  # sleep 3
  tries = 3
  loop do
    p 'done'
    exit 0 if domoz.stopped? || tries <= 0
    sleep 0.5
    tries -= 1
  end
end

domoz.run
